<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculateur d'intérêts composés</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--accent:#2563eb;--muted:#6b7280}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; padding:24px; color:#111827}
    .container{max-width:920px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:1.25rem;margin:0}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(16,24,40,0.06);}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
    label{display:block;font-size:0.85rem;color:var(--muted);margin-bottom:6px}
    input[type="number"], select{width:100%;padding:8px 10px;border:1px solid #e6e9ef;border-radius:8px;font-size:1rem}
    button{background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .result{margin-top:14px;padding:12px;border-radius:10px;background:#eef2ff}
    .muted{color:var(--muted);font-size:0.9rem}
    canvas{max-width:100%;height:320px}
    footer{margin-top:14px;font-size:0.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Calculateur d'intérêts composés</h1>
        <div class="muted">Entrez le montant, le taux annuel, la durée et vos versements mensuels.</div>
      </div>
    </header>

    <!-- Convertisseur Taux Brut -> Net -->
    <div class="card" style="margin-bottom:20px">
      <h2>Convertisseur Taux Brut → Taux Net</h2>
      <div class="grid">
        <div>
          <label for="tauxBrut">Taux brut (%)</label>
          <input id="tauxBrut" type="number" min="0" step="0.01" value="5" />
        </div>
        <div>
          <label for="regime">Régime fiscal</label>
          <select id="regime">
            <option value="normal">Normal (PFU 30%)</option>
            <option value="pea">PEA (17,2%)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px">
        <button id="convertir">Convertir</button>
      </div>
      <div id="resultNet" class="result" style="display:none"></div>
    </div>

    <!-- Calculateur avec versements mensuels -->
    <div class="card">
      <div class="grid">
        <div>
          <label for="montant">Montant initial</label>
          <input id="montant" type="number" min="0" step="0.01" value="1000" />
        </div>

        <div>
          <label for="taux">Taux annuel (%)</label>
          <input id="taux" type="number" min="0" step="0.01" value="5" />
        </div>

        <div>
          <label for="versement">Versement mensuel</label>
          <input id="versement" type="number" min="0" step="0.01" value="100" />
        </div>

        <div>
          <label for="annees">Nombre d'années</label>
          <input id="annees" type="number" min="1" step="1" value="10" />
        </div>

        <div>
          <label for="devise">Devise (affichage)</label>
          <select id="devise">
            <option value="EUR">EUR (€)</option>
            <option value="USD">USD ($)</option>
            <option value="GBP">GBP (£)</option>
            <option value="none">Sans symbole</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button id="calculer">Calculer</button>
        <button id="reset" style="background:#ef4444">Réinitialiser</button>
        <div style="margin-left:auto" class="muted">Composé annuellement (intérêts capitalisés chaque année + versements mensuels)</div>
      </div>

      <div id="result" class="result" aria-live="polite" style="display:none"></div>

      <div style="margin-top:18px">
        <canvas id="chart"></canvas>
      </div>

      <footer>
        <div class="muted">Le calcul inclut les versements mensuels, capitalisés annuellement avec les intérêts.</div>
      </footer>
    </div>
  </div>

  <script>
    // --- Convertisseur Taux Brut -> Net ---
    const tauxBrutEl = document.getElementById('tauxBrut');
    const regimeEl = document.getElementById('regime');
    const convertirBtn = document.getElementById('convertir');
    const resultNetEl = document.getElementById('resultNet');

    convertirBtn.addEventListener('click', () => {
      const tauxBrut = parseFloat(tauxBrutEl.value) || 0;
      const regime = regimeEl.value;
      let tauxNet = 0;

      if (regime === 'normal') {
        tauxNet = tauxBrut * (1 - 0.30);
      } else if (regime === 'pea') {
        tauxNet = tauxBrut * (1 - 0.172);
      }

      resultNetEl.style.display = 'block';
      resultNetEl.innerHTML = `
        <strong>Taux net :</strong> ${tauxNet.toFixed(2)}%<br>
        <small class="muted">(À partir d'un taux brut de ${tauxBrut}%)</small>
      `;
    });

    // --- Calculateur d'intérêts avec versements ---
    const montantEl = document.getElementById('montant');
    const tauxEl = document.getElementById('taux');
    const versementEl = document.getElementById('versement');
    const anneesEl = document.getElementById('annees');
    const calculerBtn = document.getElementById('calculer');
    const resetBtn = document.getElementById('reset');
    const resultEl = document.getElementById('result');
    const deviseEl = document.getElementById('devise');
    const ctx = document.getElementById('chart');

    function formatMoney(value, currencyCode) {
      if (currencyCode === 'none') return Number(value).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2});
      return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: currencyCode }).format(value);
    }

    function computeSchedule(principal, ratePercent, years, monthlyContribution) {
      const r = Number(ratePercent) / 100;
      const schedule = [];
      let balance = principal;

      for (let y = 0; y <= years; y++) {
        if (y > 0) {
          // Ajout des versements mensuels sur l'année
          for (let m = 1; m <= 12; m++) {
            balance += monthlyContribution;
            balance *= Math.pow(1 + r, 1/12); // intérêts composés mensuellement
          }
        }
        schedule.push(Number(balance.toFixed(2)));
      }
      return schedule;
    }

    let chartInstance = null;

    function drawChart(labels, data) {
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Solde au fil des années',
            data: data,
            fill: true,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius:6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { display: false } }
        }
      });
    }

    function showResult() {
      const montant = parseFloat(montantEl.value) || 0;
      const taux = parseFloat(tauxEl.value) || 0;
      const versement = parseFloat(versementEl.value) || 0;
      let annees = parseInt(anneesEl.value, 10) || 0;
      if (annees < 1) annees = 1;
      const devise = deviseEl.value;

      const schedule = computeSchedule(montant, taux, annees, versement);
      const final = schedule[schedule.length - 1];
      const totalInvesti = montant + (versement * 12 * annees);
      const gain = final - totalInvesti;
      const gainPct = (gain / totalInvesti) * 100 || 0;

      const labels = schedule.map((_, i) => i + ' an' + (i>1 ? 's' : ''));

      drawChart(labels, schedule);

      resultEl.style.display = 'block';
      resultEl.innerHTML = `
        <strong>Montant final après ${annees} an${annees>1?'s':''} :</strong> ${formatMoney(final, devise)}<br>
        <strong>Total investi :</strong> ${formatMoney(totalInvesti, devise)}<br>
        <strong>Gain net :</strong> ${formatMoney(gain, devise)} (${gainPct.toFixed(2)}%)<br>
        <small class="muted">Montant initial : ${formatMoney(montant, devise)} • Versement mensuel : ${formatMoney(versement, devise)} • Taux annuel : ${taux}%</small>
      `;
    }

    calculerBtn.addEventListener('click', showResult);

    resetBtn.addEventListener('click', ()=>{
      montantEl.value = 1000;
      tauxEl.value = 5;
      versementEl.value = 100;
      anneesEl.value = 10;
      deviseEl.value = 'EUR';
      resultEl.style.display = 'none';
      if (chartInstance) chartInstance.destroy();
    });

    [montantEl, tauxEl, versementEl, anneesEl].forEach(el => el.addEventListener('keyup', (e)=>{ if (e.key === 'Enter') showResult(); }));

    showResult();
  </script>
</body>
</html>
